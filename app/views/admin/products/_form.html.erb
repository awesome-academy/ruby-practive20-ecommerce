<%= form_with model: [:admin, product], local: true, html: { multipart: true, class: "needs-validation", novalidate: true } do |f| %>
  <%= render "shared/error_messages", object: f.object %>

  <div class="row">
    <!-- Basic Information -->
    <div class="col-md-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><%= t(".basic_information") %></h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <%= f.label :name, t(".name"), class: "form-label" %>
            <%= f.text_field :name, class: "form-control", required: true %>
            <div class="invalid-feedback">
              <%= t(".name_required") %>
            </div>
          </div>

          <div class="mb-3">
            <%= f.label :sku, t(".sku"), class: "form-label" %>
            <%= f.text_field :sku, class: "form-control", required: true %>
            <div class="invalid-feedback">
              <%= t(".sku_required") %>
            </div>
          </div>

          <div class="mb-3">
            <%= f.label :description, t(".description"), class: "form-label" %>
            <%= f.text_area :description, class: "form-control", rows: 5 %>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <%= f.label :price, t(".price"), class: "form-label" %>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <%= f.number_field :price, class: "form-control", step: 0.01, min: 0, required: true %>
                  <div class="invalid-feedback">
                    <%= t(".price_required") %>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <%= f.label :original_price, t(".original_price"), class: "form-label" %>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <%= f.number_field :original_price, class: "form-control", step: 0.01, min: 0 %>
                </div>
                <div class="form-text"><%= t(".original_price_help") %></div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <%= f.label :stock_quantity, t(".stock_quantity"), class: "form-label" %>
            <%= f.number_field :stock_quantity, class: "form-control", min: 0, required: true %>
            <div class="invalid-feedback">
              <%= t(".stock_quantity_required") %>
            </div>
          </div>
        </div>
      </div>

      <!-- Categories and Brand -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><%= t(".categorization") %></h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <%= f.label :brand_id, t(".brand"), class: "form-label" %>
            <%= f.collection_select :brand_id, Brand.all, :id, :name,
                                   { prompt: t(".select_brand") },
                                   { class: "form-select" } %>
          </div>

          <div class="mb-3">
            <%= f.label :category_ids, t(".categories"), class: "form-label" %>
            <%= f.collection_check_boxes :category_ids, Category.all, :id, :name do |b| %>
              <div class="form-check">
                <%= b.check_box(class: "form-check-input") %>
                <%= b.label(class: "form-check-label") %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Image and Settings -->
    <div class="col-md-4">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><%= t(".image") %></h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <%= f.label :images, t(".product_image"), class: "form-label" %>
            <%= f.file_field :images, class: "form-control", accept: "image/*", multiple: true %>
            <div class="form-text"><%= t(".image_help") %></div>
          </div>

          <% if product.persisted? && product.images.attached? %>
            <div class="current-images">
              <% product.images.each do |image| %>
                <div class="d-inline-block me-2 mb-2">
                  <%= image_tag image.variant(resize_to_limit: [100, 100]),
                                alt: product.name,
                                class: "img-fluid rounded" %>
                </div>
              <% end %>
              <p class="text-muted mt-2"><%= t(".current_images") %></p>
            </div>
          <% end %>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><%= t(".settings") %></h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="form-check form-switch">
              <%= f.check_box :active, class: "form-check-input" %>
              <%= f.label :active, t(".active_product"), class: "form-check-label" %>
            </div>
          </div>

          <div class="mb-3">
            <div class="form-check form-switch">
              <%= f.check_box :featured, class: "form-check-input" %>
              <%= f.label :featured, t(".featured_product"), class: "form-check-label" %>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="card">
        <div class="card-body">
          <div class="d-grid gap-2">
            <%= f.submit product.persisted? ? t(".update_product") : t(".create_product"),
                         class: "btn btn-primary" %>
            <%= link_to t(".cancel"), admin_products_path, class: "btn btn-secondary" %>
            
            <% if product.persisted? %>
              <%= link_to t(".view_product"), admin_product_path(product),
                          class: "btn btn-info btn-sm" %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>

<script>
// Bootstrap form validation
(function() {
  'use strict';
  window.addEventListener('load', function() {
    var forms = document.getElementsByClassName('needs-validation');
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();
</script>
